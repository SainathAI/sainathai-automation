name: ‚ö° Trigger Jules on Bug Label

on:
  issues:
    types: [labeled]

jobs:
  start_jules_session:
    # Only run if the label applied is 'bug' (or change to 'jules' etc.)
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    permissions:
      issues: read
    
    steps:
      - name: üîç Check for API Key
        env:
          JULES_KEY: ${{ secrets.JULES_API_KEY }}
        if: ${{ env.JULES_KEY == '' }}
        run: |
          echo "Error: JULES_API_KEY secret is missing."
          exit 1

      - name: üöÄ Trigger Jules Session
        env:
          API_KEY: ${{ secrets.JULES_API_KEY }}
          REPO_NAME: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # 1. Construct the prompt from the issue details
          # We escape quotes to ensure valid JSON
          PROMPT="Fix this issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}. \n\nDetails:\n${ISSUE_BODY}"
          
          # 2. Construct the Payload
          # Note: source format must be 'sources/github/OWNER/REPO'
          # We use jq to safely build the JSON payload to handle special characters in the prompt
          DATA=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg src "sources/github/$REPO_NAME" \
            --arg branch "$DEFAULT_BRANCH" \
            --arg title "Fix Issue #$ISSUE_NUMBER: $ISSUE_TITLE" \
            '{
              prompt: $prompt,
              sourceContext: {
                source: $src,
                githubRepoContext: {
                  startingBranch: $branch
                }
              },
              title: $title
            }')

          # 3. Send Request to Jules API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $API_KEY" \
            -d "$DATA")

          # 4. Handle Response
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Jules Session Started Successfully!"
            echo "Session Details: $BODY"
          else
            echo "‚ùå Failed to start Jules. HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
